name: Deploy to Firebase Hosting (Preview & Production)

on:
  pull_request:
    branches: [ main ]     # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ PR ‡πÄ‡∏Ç‡πâ‡∏≤ main
  push:
    branches: [ main ]     # deploy ‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ push/merge ‡πÄ‡∏Ç‡πâ‡∏≤ main
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build static files
        run: npm run build

      # ---------- PREVIEW: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PR ----------
      - name: Deploy Preview (PR)
        id: deploy_preview
        if: ${{ github.event_name == 'pull_request' }}
        shell: bash
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          set -e
          echo "Deploying preview channel for PR #${{ github.event.pull_request.number }}"

          # ‡∏î‡∏µ‡∏û‡∏•‡∏≠‡∏¢‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß (‡∏ä‡∏∑‡πà‡∏≠ channel = pr-<‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç PR>)
          OUT=$(npx firebase-tools hosting:channel:deploy "pr-${{ github.event.pull_request.number }}" \
            --only hosting \
            --project sora-rwt | tee /tmp/deploy.log)

          # ‡∏î‡∏∂‡∏á URL ‡∏à‡∏≤‡∏Å log (grep ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡∏°‡∏≤)
          URL=$(grep -Eo 'https?://[a-zA-Z0-9\-\.]+\.web\.app' /tmp/deploy.log | head -n 1)

          if [ -z "$URL" ]; then
            echo "‡πÑ‡∏°‡πà‡∏û‡∏ö Preview URL ‡πÉ‡∏ô log"
            echo "preview_url=" >> $GITHUB_OUTPUT
          else
            echo "‡∏û‡∏ö Preview URL: $URL"
            echo "preview_url=$URL" >> $GITHUB_OUTPUT
          fi

      - name: Comment Preview URL on PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const url = `${{ steps.deploy_preview.outputs.preview_url }}`.trim();
            const pr = context.payload.pull_request;
            const body = url
              ? `üîç **Preview available:** ${url}\n\nüì± ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏î **Merge** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡∏à‡∏£‡∏¥‡∏á`
              : `‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö Preview URL ‡∏à‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏î‡∏µ‡∏û‡∏•‡∏≠‡∏¢ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π logs ‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ (Deploy Preview)`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body
            });

      # ---------- PRODUCTION: ‡πÄ‡∏°‡∏∑‡πà‡∏≠ push/merge ‡πÄ‡∏Ç‡πâ‡∏≤ main ----------
      - name: Deploy Production (main)
        if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          npx firebase-tools deploy --only hosting --project sora-rwt
